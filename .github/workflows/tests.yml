name: Testes Automatizados e Qualidade de Código

on:
  push:
    branches: [ main, principal ]
  pull_request:
    branches: [ main, principal ]

permissions:
  contents: read

jobs:
  test:
    name: Executar Testes e Linting
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout do código
    - name: Checkout código
      uses: actions/checkout@v4
      
    # 2. Configurar Python
    - name: Configurar Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
  # 3. Instalar dependências (incluindo pytest, pytest-cov e flake8)
- name: Instalar dependências
  run: |
    python -m pip install --upgrade pip
    pip install flake8 pytest pytest-cov
    if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

        
    # 4. Verificar Qualidade do Código com Flake8 (Novo Passo)
    # Garante que o código segue o padrão PEP 8 antes de rodar testes
    - name: Validar Estilo de Código com Flake8
      run: |
        # Flake8 verifica os diretórios src e tests
        # Se houver erros de estilo, o workflow FALHA aqui.
        flake8 . --max-line-length=100
        
    # 5. Executar testes com cobertura (Passo Único e Correto)
    - name: Executar Testes com Cobertura
      run: |
        # Exportar o path é crucial para que o Python encontre os módulos em 'src'
        export PYTHONPATH=$PYTHONPATH:$(pwd)/src:$(pwd)
        pytest -v --cov=src --cov-report=term-missing tests/
